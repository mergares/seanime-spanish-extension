{
  "id": "animeflv",
  "name": "AnimeFLV",
  "version": "1.1.9",
  "manifestURI": "https://raw.githubusercontent.com/mergares/seanime-spanish-extension/refs/heads/main/manifest.json",
  "language": "typescript",
  "type": "onlinestream-provider",
  "description": "AnimeFLV via local API with full server picker. Prefers working hosts (SW/StreamTape/Fembed) and shows servers before first play.",
  "author": "Your Name",
  "icon": "https://raw.githubusercontent.com/your-username/seanime-extensions/main/animeflv/logo.png",
  "website": "http://100.91.179.28:3003/anime/flv",
  "lang": "es",
  "payload": "type SubOrDub='sub'|'dub';interface Settings{episodeServers:string[];supportsDub:boolean;}interface SearchOptions{query:string;dub?:boolean;}interface SearchResult{id:string;title:string;url:string;subOrDub:SubOrDub;}interface Episode{id:string;number:number;title:string;url:string;thumbnail?:string;}interface EpisodeDetails{id:string;number:number;}interface VideoSource{url:string;type:'hls'|'mp4'|string;quality:string|number;subtitles?:any[]}interface EpisodeServer{server:string;headers:Record<string,string>;videoSources:VideoSource[]}interface EpSrvItem{name?:string;file_url?:string;url?:string;file?:string;type?:string;quality?:string|number}class Provider{private baseUrl='http://100.91.179.28:3003/anime/flv';private lastServers:string[]=['Auto','SW','Stape','Fembed','Okru','YourUpload','Netu','MEGA'];getSettings():Settings{return{episodeServers:this.lastServers.slice(),supportsDub:false};}private isSlug(s:string){if(!s)return false;for(var i=0;i<s.length;i++){var c=s.charAt(i);var ok=(c>='a'&&c<='z')||(c>='A'&&c<='Z')||(c>='0'&&c<='9')||c==='-'||c==='_'||c==='.';if(!ok)return false;}return true;}private slugify(q:string){q=(q||'').toLowerCase().trim();var out='';for(var i=0;i<q.length;i++){var c=q.charAt(i);if((c>='a'&&c<='z')||(c>='0'&&c<='9')||c==='-')out+=c;else if(c===' '||c==='_')out+='-';}while(out.indexOf('--')!==-1){out=out.replace('--','-');}if(out.charAt(0)==='-')out=out.substring(1);if(out.charAt(out.length-1)==='-')out=out.substring(0,out.length-1);return out;}private async fetchJSON(u:string){var r=await fetch(u);if(!r.ok)return{ok:false,json:null};try{var j=await r.json();return{ok:true,json:j};}catch(_){return{ok:false,json:null};}}private chooseFirstResult(d:any){if(!d)return null;var first=(Array.isArray(d.results)?d.results[0]:(d.anime?d.anime:d));if(!first)return null;return{slug:first.slug||first.id,name:first.name||first.title||(first.slug||first.id)};}async search(opts:SearchOptions):Promise<SearchResult[]>{try{var q=(opts&&opts.query?(''+opts.query):'').trim();if(!q)return[];if(this.isSlug(q)){return[{id:q,title:q,url:this.baseUrl+'/name/'+encodeURIComponent(q),subOrDub:(opts&&opts.dub)?'dub':'sub'}];}var res=await this.fetchJSON(this.baseUrl+'/search/'+encodeURIComponent(q));if(res.ok){var pick=this.chooseFirstResult(res.json);if(pick&&pick.slug){return[{id:pick.slug,title:pick.name,url:this.baseUrl+'/name/'+pick.slug,subOrDub:(opts&&opts.dub)?'dub':'sub'}];}}var guess=this.slugify(q);var try1=await this.fetchJSON(this.baseUrl+'/name/'+encodeURIComponent(guess));if(try1.ok&&try1.json&&Array.isArray(try1.json.episodes)&&try1.json.episodes.length){return[{id:guess,title:try1.json.name||guess,url:this.baseUrl+'/name/'+guess,subOrDub:(opts&&opts.dub)?'dub':'sub'}];}var tv=guess+'-tv';var try2=await this.fetchJSON(this.baseUrl+'/name/'+encodeURIComponent(tv));if(try2.ok&&try2.json&&Array.isArray(try2.json.episodes)&&try2.json.episodes.length){return[{id:tv,title:try2.json.name||tv,url:this.baseUrl+'/name/'+tv,subOrDub:(opts&&opts.dub)?'dub':'sub'}];}return[];}catch(e){console.error('[animeflv] search error:',e);return[];}}async findEpisodes(id:string):Promise<Episode[]>{try{const toInt=(v:any)=>{var n=parseInt(v,10);return isFinite(n)?n:NaN;};async function asEpisodes(self:any,slug:string){var r=await self.fetchJSON(self.baseUrl+'/name/'+encodeURIComponent(slug));if(!(r.ok&&r.json))return null;var a=r.json;var cover=a&&a.image&&a.image.url?a.image.url:'';var eps=(a&&Array.isArray(a.episodes))?a.episodes:[];if(!eps.length)return null;var out:Episode[]=[];for(var i=0;i<eps.length;i++){var e=eps[i]||{};var n=toInt(e.number);if(!isFinite(n))continue;var title=e&&e.name?e.name:('Episode '+n);var u=e&&e.url?(e.url.indexOf('http')===0?e.url:(self.baseUrl+e.url)):'';var th=e&&e.image?e.image:(cover||undefined);out.push({id:slug,number:n,title:title,url:u,thumbnail:th});}return out;}var variants=[id];if(id.indexOf('-tv')===-1)variants.push(id+'-tv');var res=null;for(var i=0;i<variants.length;i++){res=await asEpisodes(this,variants[i]);if(res&&res.length)return res;}var seek=this.chooseFirstResult((await this.fetchJSON(this.baseUrl+'/search/'+encodeURIComponent(id))).json);if(seek&&seek.slug){res=await asEpisodes(this,seek.slug);if(res&&res.length)return res;}return[];}catch(e){console.error('[animeflv] findEpisodes error:',e);return[];}}async findEpisodeServer(ep:EpisodeDetails,choice:string):Promise<EpisodeServer>{var slug=(ep&&ep.id)?ep.id:'';var num=typeof ep.number==='number'?ep.number:parseInt((ep as any).number,10);if(!slug||!isFinite(num as any))throw new Error('Invalid episode reference');var slugNum=slug+'-'+num;var r=await this.fetchJSON(this.baseUrl+'/episode/'+encodeURIComponent(slugNum));if(!(r.ok&&r.json))throw new Error('Server request failed');var list:EpSrvItem[]=Array.isArray(r.json.servers)?r.json.servers:[];if(!list.length)throw new Error('No servers available');var names:string[]=[];for(var i=0;i<list.length;i++){var nm=list[i]&&list[i].name?list[i].name:null;if(nm&&names.indexOf(nm)===-1)names.push(nm);}this.lastServers=['Auto'].concat(names.length?names:['SW','Stape','Fembed','Okru','YourUpload','Netu','MEGA']);function norm(n:string){var s=(n||'').toLowerCase();if(s==='sw'||s==='streamwish')return 'sw';if(s==='stape'||s==='streamtape')return 'stape';if(s==='fembed'||s==='embedsito')return 'fembed';if(s==='okru'||s==='ok')return 'okru';if(s==='yourupload'||s==='yu')return 'yourupload';if(s==='netu'||s==='hqq')return 'netu';if(s==='mega')return 'mega';return s;}function inferType(u:string){return u.slice(-5)==='.m3u8'?'hls':'mp4';}function pickByName(arr:EpSrvItem[], name:string){var w=norm(name);for(var i=0;i<arr.length;i++){var it=arr[i];var nm=norm((it&&it.name)?(''+it.name):'');if(nm===w)return it;}for(var j=0;j<arr.length;j++){var it2=arr[j];var nm2=norm((it2&&it2.name)?(''+it2.name):'');if(nm2.indexOf(w)!==-1)return it2;}return undefined;}var autoOrder=['sw','stape','fembed','okru','yourupload','netu','mega'];if(choice&&choice!=='Auto'){var sel=pickByName(list,choice);if(!sel)sel=list[0];var file=(sel&&(sel.file_url||sel.url||sel.file))?(sel.file_url||sel.url||sel.file):'';if(!file)throw new Error('Selected server has no media URL');var vtype=(sel&&sel.type)?sel.type:inferType(file);return{server:(sel.name||choice),headers:{},videoSources:[{url:file,type:vtype,quality:(sel.name||'auto'),subtitles:[]}]};}for(var a=0;a<autoOrder.length;a++){var selAuto=pickByName(list,autoOrder[a]);if(!selAuto)continue;var file2=(selAuto.file_url||selAuto.url||selAuto.file)||'';if(!file2)continue;var t=selAuto.type?selAuto.type:inferType(file2);return{server:(selAuto.name||'Auto'),headers:{},videoSources:[{url:file2,type:t,quality:(selAuto.name||'auto'),subtitles:[]}]};}for(var z=0;z<list.length;z++){var any=list[z]||{};var file3=(any.file_url||any.url||any.file)||'';if(!file3)continue;var t3=any.type?any.type:inferType(file3);return{server:(any.name||'Auto'),headers:{},videoSources:[{url:file3,type:t3,quality:(any.name||'auto'),subtitles:[]}]};}throw new Error('No valid sources');}}"
}
